name: Auto Traceability
on:
  issues:
    types: [opened, edited]

jobs:
  auto-traceability:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Analyze issue and auto-classify
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title;
            const body = issue.body || '';

            const requirementMap = {
              // RF1 - Projetos
              'projeto': 'RF1-PROJ',
              'project': 'RF1-PROJ',
              'lista.*projeto': 'RF1-PROJ-LIST',
              'detalhe.*projeto': 'RF1-PROJ-DETAIL',

              // RF2 - Issues
              'issue': 'RF2-ISSUE',
              'tarefa': 'RF2-ISSUE',
              'card': 'RF2-ISSUE',
              'lista.*issue': 'RF2-ISSUE-LIST',
              'detalhe.*issue': 'RF2-ISSUE-DETAIL',

              // RF3 - Usuários
              'usuário': 'RF3-USER',
              'user': 'RF3-USER',
              'perfil': 'RF3-USER',
              'acesso': 'RF3-USER-MANAGE',
              'permissão': 'RF3-USER-MANAGE',
              'gerenciar.*usuário': 'RF3-USER-MANAGE',

              // RF4 - Dashboards
              'dashboard': 'RF4-DASH',
              'relatório': 'RF4-DASH',
              'métrica': 'RF4-DASH',
              'gráfico': 'RF4-DASH',
              'dashboard.*projeto': 'RF4-DASH-PROJ',
              'dashboard.*issue': 'RF4-DASH-ISSUE',

              // RNF1 - Desempenho
              'desempenho': 'RNF1-PERF',
              'performance': 'RNF1-PERF',
              'tempo.*resposta': 'RNF1-PERF-RESPONSE',
              'escalabilidade': 'RNF1-PERF-SCALE',

              // RNF2 - Segurança
              'segurança': 'RNF2-SEC',
              'security': 'RNF2-SEC',
              'autenticação': 'RNF2-SEC-AUTH',
              'login': 'RNF2-SEC-AUTH',
              'acesso.*controle': 'RNF2-SEC-ACCESS',
              'permissão': 'RNF2-SEC-ACCESS',

              // RNF3 - Usabilidade
              'usabilidade': 'RNF3-UX',
              'ux': 'RNF3-UX',
              'design': 'RNF3-UX-RESP',
              'responsivo': 'RNF3-UX-RESP',

              // RNF4 - Manutenibilidade
              'manutenibilidade': 'RNF4-MAIN',
              'manutenção': 'RNF4-MAIN',
              'código.*limpo': 'RNF4-MAIN-CODE',
              'clean.*code': 'RNF4-MAIN-CODE',
              'teste': 'RNF4-MAIN-CODE',
              'test.*coverage': 'RNF4-MAIN-CODE',
              'arquitetura': 'RNF4-MAIN-ARCH',
              'modular': 'RNF4-MAIN-ARCH',
              'microserviço': 'RNF4-MAIN-ARCH',
              'log': 'RNF4-MAIN-LOGS',
              'monitoramento': 'RNF4-MAIN-LOGS',
              'erro': 'RNF4-MAIN-LOGS',
              'debug': 'RNF4-MAIN-LOGS',

              // RNF5 - Disponibilidade
              'disponibilidade': 'RNF5-AVAIL',
              'uptime': 'RNF5-AVAIL-UPTIME',
              'tempo.*atividade': 'RNF5-AVAIL-UPTIME',
              '24.*7': 'RNF5-AVAIL-UPTIME',
              'notificação': 'RNF5-AVAIL-NOTIFY',
              'manutenção.*programada': 'RNF5-AVAIL-NOTIFY',
              'indisponibilidade': 'RNF5-AVAIL-NOTIFY'

              // RNF6 - Portabilidade
              'portabilidade': 'RNF6-PORT',
              'compatibilidade': 'RNF6-PORT-BROWSER',
              'navegador': 'RNF6-PORT-BROWSER',
              'browser': 'RNF6-PORT-BROWSER',
              'docker': 'RNF6-PORT-DOCKER',
              'container': 'RNF6-PORT-DOCKER',
              'api.*externa': 'RNF6-PORT-API',
              'integração': 'RNF6-PORT-API',
              'swagger': 'RNF6-PORT-API',
              'openapi': 'RNF6-PORT-API',
              'documentação.*api': 'RNF6-PORT-API'
            };

            let detectedRequirements = [];
            const searchText = (title + ' ' + body).toLowerCase();

            // Busca por palavras-chave
            for (const [pattern, requirement] of Object.entries(requirementMap)) {
              const regex = new RegExp(pattern, 'i');
              if (regex.test(searchText)) {
                detectedRequirements.push(requirement);
              }
            }

            // Remove duplicatas e pega o primeiro requisito detectado
            const uniqueReqs = [...new Set(detectedRequirements)];

            if (uniqueReqs.length > 0) {
              const primaryRequirement = uniqueReqs[0];

              // Adiciona label do requisito
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: [primaryRequirement, 'auto-classified']
              });

              // Cria comentário com sugestão de template
              const template = `
                **Auto Traceability**

                Detectei que esta issue pode estar relacionada ao requisito: **${primaryRequirement}**

                **Sugestão de template para o corpo da issue:**

                \`\`\`markdown
                **Requisito:** ${primaryRequirement}-${issue.number.toString().padStart(3, '0')}
                **Atende a:** ${primaryRequirement} - [Ver documento completo](/documentacao/produto/requisitos.md)

                ## Descrição
                ${body}

                ## Critérios de Aceite
                - [ ] [Descreva o primeiro critério]
                - [ ] [Descreva o segundo critério]

                ---

                *Classificação automática - Revisar e ajustar se necessário*
                \`\`\`

                _Mantenha a descrição original e adicione as informações de traceability acima._
                              `;

                              await github.rest.issues.createComment({
                                owner: context.repo.owner,
                                repo: context.repo.repo,
                                issue_number: issue.number,
                                body: template
                              });

                              console.log(`Issue #${issue.number} classificada como: ${primaryRequirement}`);
                            } else {
                              console.log(`Nenhum requisito detectado para issue #${issue.number}`);
                            }
