name: Push Traceability - Complete Lint Analysis

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev

jobs:
  complete_lint_analysis:
    name: Análise Lint (Files Changed)
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1.1 - Identificar arquivos modificados
      - name: Get Changed Files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          base_sha: ${{ github.event.before }}
          sha: ${{ github.sha }}

      # 1.2 - Configurar Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 1.3 - Instalar UV e Ferramentas
      - name: Install uv and Tools
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          uv tool install ruff

      # 1.4 - Análise Lint Completa (Arquivos Alterados)
      - name: Complete Lint Analysis (Changed Files)
        run: |
          CHANGED_FILES="${{ steps.changed-files.outputs.all_changed_files }}"
          PYTHON_FILES=()
          YAML_FILES=()

          for file in $CHANGED_FILES; do
            if [[ "$file" == *.py ]]; then
              PYTHON_FILES+=("$file")
            elif [[ "$file" == *.yml || "$file" == *.yaml ]]; then
              YAML_FILES+=("$file")
            fi
          done

          echo "Arquivos modificados detectados:"
          echo "Python: ${#PYTHON_FILES[@]}"
          echo "YAML: ${#YAML_FILES[@]}"

          # LINT PARA ARQUIVOS PYTHON
          if [ ${#PYTHON_FILES[@]} -gt 0 ]; then
            echo "::group::Análise Python (${#PYTHON_FILES[@]} arquivos)"
            echo "Arquivos: ${PYTHON_FILES[*]}"

            # 1.4.1 - Lint Básico (Erros e Warnings)
            echo "Lint Básico (F, E, W)"
            uv run ruff check --output-format=github "${PYTHON_FILES[@]}"

            # 1.4.2 - Lint de Importação
            echo "Lint de Importação (I)"
            uv run ruff check --select=I --output-format=github "${PYTHON_FILES[@]}"

            # 1.4.3 - Lint de Nomenclatura
            echo "Lint de Nomenclatura (N)"
            uv run ruff check --select=N --output-format=github "${PYTHON_FILES[@]}"

            # 1.4.4 - Lint de Documentação
            echo "Lint de Documentação (D)"
            uv run ruff check --select=D --output-format=github "${PYTHON_FILES[@]}" || true

            # 1.4.5 - Lint de Anotações de Tipo
            echo "Lint de Anotações de Tipo (ANN)"
            uv run ruff check --select=ANN --output-format=github "${PYTHON_FILES[@]}"

            # 1.4.6 - Lint de Refatoração
            echo "Lint de Refatoração (RUF)"
            uv run ruff check --select=RUF --output-format=github "${PYTHON_FILES[@]}"

            # 1.4.7 - Lint de Compatibilidade
            echo "Lint de Compatibilidade (COM)"
            uv run ruff check --select=COM --output-format=github "${PYTHON_FILES[@]}"

            # 1.4.8 - Lint de Complexidade
            echo "Lint de Complexidade (C90)"
            uv run ruff check --select=C90 --output-format=github "${PYTHON_FILES[@]}" || true

            echo "::endgroup::"
          else
            echo "Nenhum arquivo Python para análise"
          fi

          # LINT PARA YAML
          if [ ${#YAML_FILES[@]} -gt 0 ]; then
            echo "::group::Lint YAML (${#YAML_FILES[@]} arquivos)"
            for yaml_file in "${YAML_FILES[@]}"; do
              echo "Analisando: $yaml_file"
              uv run yamllint "$yaml_file" --format github || true
            done
            echo "::endgroup::"
          fi
